datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model WebhookEvent {
  id        Int      @id @default(autoincrement())
  provider  String
  event     String?
  eventType String?  @map("event_type")
  eventId   String   @unique @map("event_id")
  reference String?
  payload   Json?
  createdAt DateTime @default(now()) @map("created_at")
  receivedAt DateTime? @default(now()) @map("received_at")

  @@map("webhook_events")
}

model LedgerEntry {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         Int?     @map("user_id")
  amount         Decimal  @db.Decimal(12, 2)
  direction      String
  balanceType    String   @map("balance_type")
  type           String?
  reference      String?
  idempotencyKey String   @unique @map("idempotency_key")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("ledger_entries")
}

model Wallet {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique @map("user_id")
  balance          Decimal  @default(0) @db.Decimal(12, 2)
  availableBalance Decimal  @default(0) @map("available_balance") @db.Decimal(12, 2)
  escrowBalance    Decimal  @default(0) @map("escrow_balance") @db.Decimal(12, 2)
  createdAt        DateTime @default(now()) @map("created_at")

  reconciliationLogs  ReconciliationLog[]
  reconciliationFlags ReconciliationFlag[]

  @@map("wallets")
}

model ReconciliationLog {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId          Int      @map("wallet_id")
  availableExpected Decimal  @map("available_expected") @db.Decimal(12, 2)
  availableActual   Decimal  @map("available_actual") @db.Decimal(12, 2)
  escrowExpected    Decimal  @map("escrow_expected") @db.Decimal(12, 2)
  escrowActual      Decimal  @map("escrow_actual") @db.Decimal(12, 2)
  status            String
  createdAt         DateTime @default(now()) @map("created_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("reconciliation_logs")
}

model ReconciliationFlag {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId  Int      @map("wallet_id")
  reason    String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("reconciliation_flags")
}

model SettlementReport {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reportDate          DateTime @unique @map("report_date") @db.Date
  escrowInflow        Decimal  @default(0) @map("escrow_inflow") @db.Decimal(14, 2)
  releasedToStudents  Decimal  @default(0) @map("released_to_students") @db.Decimal(14, 2)
  refundedToCompanies Decimal  @default(0) @map("refunded_to_companies") @db.Decimal(14, 2)
  withdrawals         Decimal  @default(0) @db.Decimal(14, 2)
  platformFees        Decimal  @default(0) @map("platform_fees") @db.Decimal(14, 2)
  systemAvailableTotal Decimal @default(0) @map("system_available_total") @db.Decimal(14, 2)
  systemEscrowTotal   Decimal  @default(0) @map("system_escrow_total") @db.Decimal(14, 2)
  createdAt           DateTime @default(now()) @map("created_at")

  @@map("settlement_reports")
}

model FraudFlag {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        Int      @map("user_id")
  ruleTriggered String   @map("rule_triggered")
  riskScore     Int      @map("risk_score")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("fraud_flags")
}

model UserRiskProfile {
  userId               Int      @id @map("user_id")
  totalWithdrawals     Int      @default(0) @map("total_withdrawals")
  totalReleases        Int      @default(0) @map("total_releases")
  disputesCount        Int      @default(0) @map("disputes_count")
  avgTimeToWithdrawal  Float?   @map("avg_time_to_withdrawal")
  withdrawalVelocity   Float?   @map("withdrawal_velocity")
  lastActivityAt       DateTime? @map("last_activity_at")
  riskScore            Int      @default(0) @map("risk_score")
  updatedAt            DateTime @default(now()) @map("updated_at")

  @@map("user_risk_profiles")
}

model FraudReview {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       Int       @map("user_id")
  paymentId    Int?      @map("payment_id")
  withdrawalId Int?      @map("withdrawal_id")
  riskScore    Int       @default(0) @map("risk_score")
  reason       String
  status       String    @default("PENDING")
  createdAt    DateTime  @default(now()) @map("created_at")
  reviewedBy   Int?      @map("reviewed_by")
  reviewedAt   DateTime? @map("reviewed_at")
  adminNote    String?   @map("admin_note")

  @@map("fraud_reviews")
}

model WalletRestriction {
  userId    Int      @id @map("user_id")
  reason    String
  createdAt DateTime @default(now()) @map("created_at")

  @@map("wallet_restrictions")
}
