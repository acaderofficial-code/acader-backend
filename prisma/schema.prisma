datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model WebhookEvent {
  id        Int      @id @default(autoincrement())
  provider  String
  event     String?
  eventType String?  @map("event_type")
  eventId   String   @unique @map("event_id")
  reference String?
  payload   Json?
  createdAt DateTime @default(now()) @map("created_at")
  receivedAt DateTime? @default(now()) @map("received_at")

  @@map("webhook_events")
}

model LedgerEntry {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         Int?     @map("user_id")
  amount         Decimal  @db.Decimal(12, 2)
  direction      String
  balanceType    String   @map("balance_type")
  type           String?
  reference      String?
  idempotencyKey String   @unique @map("idempotency_key")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("ledger_entries")
}

model Wallet {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique @map("user_id")
  balance          Decimal  @default(0) @db.Decimal(12, 2)
  availableBalance Decimal  @default(0) @map("available_balance") @db.Decimal(12, 2)
  escrowBalance    Decimal  @default(0) @map("escrow_balance") @db.Decimal(12, 2)
  createdAt        DateTime @default(now()) @map("created_at")

  reconciliationLogs  ReconciliationLog[]
  reconciliationFlags ReconciliationFlag[]

  @@map("wallets")
}

model ReconciliationLog {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId          Int      @map("wallet_id")
  availableExpected Decimal  @map("available_expected") @db.Decimal(12, 2)
  availableActual   Decimal  @map("available_actual") @db.Decimal(12, 2)
  escrowExpected    Decimal  @map("escrow_expected") @db.Decimal(12, 2)
  escrowActual      Decimal  @map("escrow_actual") @db.Decimal(12, 2)
  status            String
  createdAt         DateTime @default(now()) @map("created_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("reconciliation_logs")
}

model ReconciliationFlag {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId  Int      @map("wallet_id")
  reason    String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("reconciliation_flags")
}
